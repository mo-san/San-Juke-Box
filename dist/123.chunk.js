"use strict";(self.webpackChunksan_juke_box=self.webpackChunksan_juke_box||[]).push([[123],{3123:(e,t,i)=>{i.r(t),i.d(t,{default:()=>R});var s=i(2738),n=i(7294),r=i(917),a=i(6566),o=(i(1031),i(1396)),h=i(913),c=i(7607),l=i(5716),d=i(9957),f=i(7297),m=i(5796),p=i(5317),w=i(9276),u=i.n(w);l.ZP.registerPlugin(u());class g{constructor(e){this.movingParticles=new o.Object3D,this.particlesList=[],this.silhouette="img/logo.min.svg",this.fontSize=42,this.spriteCanvasWidth=250,this.spriteCanvasHeight=100,this.spriteCharsPerLine=8,this.spritePixelsPerDimension=256,this.spriteFont=f.o.getState().fontName,this.init=async()=>{const e=this.createSprite();this.particlesList=this.createLetterParticle(e);const t=await this.createCanvasForSilhouette();this.createMovingLetters(t)},this.changeFont=e=>{this.spriteFont=e,this.particlesList=[],this.movingParticles=new o.Object3D,this.init()},this.createSprite=()=>{const e=document.createElement("canvas");e.setAttribute("width",this.spritePixelsPerDimension*this.spriteCharsPerLine+"px"),e.setAttribute("height",this.spritePixelsPerDimension*this.spriteCharsPerLine+"px");const t=e.getContext("2d");t.fillStyle="white",t.font=`200px ${this.spriteFont}`,t.textAlign="center",t.textBaseline="middle";const i=this.spriteCharsPerLine*this.spriteCharsPerLine;for(let e=0;e<i;e++){const i=this.spritePixelsPerDimension*(e%this.spriteCharsPerLine)+this.spritePixelsPerDimension/2,s=this.spritePixelsPerDimension*Math.floor(e/this.spriteCharsPerLine)+this.spritePixelsPerDimension/2;t.fillText(this.spriteString[e],i,s)}return new o.CanvasTexture(e)},this.getUvRandomizedGeometry=()=>{const e=1/this.spriteCharsPerLine,t=Math.floor(this.spriteCharsPerLine*Math.random()),i=Math.floor(this.spriteCharsPerLine*Math.random()),s=new o.PlaneBufferGeometry(40,40),n=s.getAttribute("uv"),r=new o.Vector2;for(let s=0;s<n.count;s++){const a=r.fromBufferAttribute(n,s);n.setXY(s,e*(a.x+t),e*(a.y+i))}return s},this.createLetterParticle=e=>{const t=[];for(let i=0;i<this.spriteCanvasWidth;i++)for(let i=0;i<this.spriteCanvasHeight;i++){const i=this.getUvRandomizedGeometry(),s=new o.MeshStandardMaterial({color:16777215,map:e,transparent:!0,side:o.DoubleSide});s.blending=o.AdditiveBlending;const n=new o.Mesh(i,s);t.push(n)}return t},this.loadImage=e=>new Promise((t=>{const i=new Image;i.onload=()=>t(i),i.src=e})),this.createCanvasForSilhouette=async()=>{const e=this.silhouette,t=document.createElement("canvas");t.setAttribute("width",`${this.spriteCanvasWidth}px`),t.setAttribute("height",`${this.spriteCanvasHeight}px`);const i=t.getContext("2d");if(/\.(png|jpg|webp|bmp|gif|svg)$/.test(e)){const t=await this.loadImage(e);console.info(`Image loaded. width: ${t.width}, height: ${t.height}`),i.drawImage(t,0,0)}else i.fillStyle="white",i.font=`${this.fontSize}px ${this.spriteFont}`,i.textAlign="center",i.textBaseline="top",i.fillText(e,this.spriteCanvasWidth/2,0);return t},this.createMovingLetters=e=>{const t=(e,t)=>{const i=e;return i.position.x=t.x,i.position.y=t.y,i.position.z=t.z,i.rotation.z=10*Math.PI*(Math.random()-.5),i},i=(e,t,i,s)=>{l.ZP.timeline().set(e,{visible:!0},t).to(e.rotation,{z:0,ease:p.Ll.easeInOut,duration:6},t).to(e.position,{delay:t,ease:p.Au.easeInOut,duration:7,motionPath:{path:[i,{x:s.x/2+300,y:(i.y+s.y)/2+500*Math.random(),z:(i.z+s.z)/2},s]}},0)};this.particlesList.forEach((e=>{e.visible=!1,e.material.blending=o.AdditiveBlending}));const s=e.getContext("2d").getImageData(0,0,this.spriteCanvasWidth,this.spriteCanvasHeight).data;let n=-1;for(let a=0;a<this.spriteCanvasWidth;a++)for(let o=0;o<this.spriteCanvasHeight;o++){if(0===s[4*(a+o*this.spriteCanvasWidth)+3])continue;n+=1;const h={x:2e3*(Math.random()-.5)-500,y:1e3*(Math.random()-.5),z:1e4},c=(r=o,{x:30*(a-e.width/2),y:30*(e.height/2-r),z:0}),l=3*p.Ll.easeInOut(n/1600)+1.5*Math.random(),d=t(this.particlesList[n],h);this.movingParticles.add(d),i(d,l,h,c)}var r},this.spriteString=e,this.init()}}var v,x,M,P,C,y,b=i(552),S=function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};v=new WeakMap,x=new WeakMap,M=new WeakMap,P=new WeakMap,C=new WeakMap,y=new WeakMap;var k,W,L,A=i(4391),z=function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};class B extends class{constructor(e,t){this.frameRateWeight=1,this.frames=0,v.set(this,(()=>{const e=new o.WebGLRenderer({canvas:this.canvas,alpha:!0,antialias:!0});return e.setClearColor("#ffffff",0),e.setPixelRatio(window.devicePixelRatio),e.setSize(window.innerWidth,window.innerHeight),e})),x.set(this,(()=>{const e=new o.Scene;return e.background=null,e})),M.set(this,(e=>{if("Orthographic"===e){const e=new o.OrthographicCamera(0,100,100,0,.1,1e4);return e.position.set(0,0,20),e}const t=new o.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e5);return t.position.set(0,0,20),t})),P.set(this,(e=>new o.AmbientLight(e))),C.set(this,(e=>{const t=new o.DirectionalLight(e);return t.position.set(-1,1,1).normalize(),t})),y.set(this,(()=>{this.camera instanceof o.PerspectiveCamera&&(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()),(this.effect??this.renderer).setSize(window.innerWidth,window.innerHeight)})),this.getFrameRateWeight=()=>{const e=f.o.getState().gpuTier;if(f.o.getState().isMobileGpu){if(e>2)return 1;if(2===e)return 2;if(e<2)return 3}return e>2?1:2===e?2:e<2?3:1},this.canvas=e,this.renderer=S(this,v,"f").call(this),"Perspective"===t&&(this.effect=new b.M(this.renderer)),this.camera=S(this,M,"f").call(this,t),this.scene=S(this,x,"f").call(this),this.scene.add(S(this,P,"f").call(this,"#666666")),this.scene.add(S(this,C,"f").call(this,"#887766")),this.frameRateWeight=this.getFrameRateWeight(),window.addEventListener("resize",S(this,y,"f"))}}{constructor(e,t){super(e,"Perspective"),this.lyricsChars=new Map,this._previousBpm=0,this.effectRank=0,this.init=async()=>{await Ammo(Ammo),this.scene.add(await z(this,W,"f").call(this)),z(this,k,"f").call(this,0)},k.set(this,(e=>{const t=this.timer.getDelta();setTimeout((()=>{requestAnimationFrame((e=>z(this,k,"f").call(this,e)))}),1e3/60/this.frameRateWeight);const{selectedModelNames:i}=f.o.getState();z(this,L,"f").call(this,i);for(const t of i)e%1e3<=40&&m.M.blink(t,0),e%1e3>=500&&e%1e3<=550&&m.M.blink(t,1),Math.random()>.95&&m.M.mouthFlap(t,Math.random());this.camera.lookAt(new o.Vector3(0,6,0)),this.stats?.update(),(this.effect??this.renderer).render(this.scene,this.camera),m.M.helper.update(t)})),this.letterPainter=async()=>(await(0,d.mx)(f.o.getState().fontName),new g(this.lyricText).movingParticles),this.addModel=async e=>{const t=await m.M.loadMmdModel(e);await m.M.loadMotion(e,t),(0,d.Q1)(e),t.visible=!1,this.scene.add(t);const i=m.M.createSampler(t,e);this.scene.add(i),l.ZP.timeline().to(i.material.uniforms.progress,{value:1,duration:2,onComplete:()=>{i.visible=!1,t.visible=!0}})},this.removeModel=async e=>{this.scene.getObjectByName(e)?.removeFromParent()},this.createController=()=>{const e=new h.z(this.camera,document.querySelector("article"));return e.rotateSpeed=3,e},W.set(this,(async()=>{const e=f.o.getState().gpuTier,t=e>2?700:2===e?300:150,i=new o.Vector3(0,0,0),s=new o.Color,n=()=>{const e=2*Math.random()*Math.PI,t=400*Math.random(),i=new o.Vector3(Math.sin(e)*t,0,Math.cos(e)*t);return i.lengthSq()>=400?i:n()},r=await(new c.E).loadAsync("assets/models/BlockMan/BlockMan.glb"),{geometry:a,material:h}=r.scene.getObjectByName("Proxy"),l=a.clone();l.scale(.1,.1,.1);const d=new o.InstancedMesh(l,h,t);for(let e=0;e<t;e++){const t=Math.min(1.2*parseInt(A.Z.getRandomColor().slice(1),16),16777215);s.set(t),d.setColorAt(e,s);const r=n();d.setMatrixAt(e,(new o.Matrix4).setPosition(r).lookAt(i,r,d.up))}return d.instanceMatrix.needsUpdate=!0,d})),L.set(this,(e=>{const t=document.getElementById("BPM"),i=document.getElementById("Letter"),s=document.getElementById("Furigana");if(!t||!i||!s)return;const n=this.refTextAlive?.current.currentBpm??0;n!==this._previousBpm&&(this._previousBpm=n);for(const t of e){const e=m.M.findMotion(t,"スクワット");e&&(e.timeScale=n/120)}t.textContent=String(this.refTextAlive?.current.currentBpm??0),i.textContent=this.refTextAlive?.current.currentLetter?.letter??"",s.textContent=this.refTextAlive?.current.currentFurigana??""})),this.onModelUpdated=(e,t)=>{const i=e.filter((e=>!t.includes(e))),s=t.filter((t=>!e.includes(t)));i.forEach((e=>this.addModel(e))),s.forEach((e=>this.removeModel(e)))},t&&(this.stats=t),this.timer=new o.Clock;const i=new o.PolarGridHelper(500);this.scene.add(i),this.camera.position.y=5,f.o.subscribe((e=>{console.info(`new effect rank: ${e}`),this.effectRank=e}),(e=>e.effectRank)),this.refTextAlive=f.o.getState().refTextAlive,this.init()}}k=new WeakMap,W=new WeakMap,L=new WeakMap;const E=n.forwardRef((({id:e,zIndex:t},i)=>{function a(e,t){e.width=window.innerWidth,e.height=window.innerWidth*t}return(0,n.useEffect)((()=>{const e=i.current,t=window.innerHeight/window.innerWidth;a(e,t),window.addEventListener("resize",(()=>a(e,t)))}),[]),(0,s.tZ)("canvas",{id:e,ref:i,css:r.iv`
        display: block;
        z-index: ${t};
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        max-width: 100vw;
        height: 100vh;
        max-height: 100vh;
      `},void 0)})),I=({text:e,id:t})=>(0,s.tZ)(a.xv,{text:e,fontSize:70,fontFamily:f.o.getState().fontName,name:`Text-${t}`,x:1.2*window.innerWidth,y:1.2*window.innerHeight,fill:"#151515",stroke:"#f0f0f0",strokeWidth:10,fillAfterStrokeEnabled:!0},void 0),T=(e,t)=>{e(t?[...t.values()].filter((({letter:e})=>""!==e)).map((e=>(0,s.tZ)(I,{text:e.letter,id:e.index},e.index))):[])},R=({zIndex:e})=>{const[t,i]=(0,n.useState)([]),o=(0,n.useRef)(null),h=(0,n.useRef)(null);return(0,n.useEffect)((()=>{const e=o.current,t=new B(e,d.Vh);f.o.setState({instanceStage:t,refKonvaLayer:h.current.getLayers()[0]}),(0,d.Je)(),(0,d.Ym)(),setTimeout((()=>f.o.getState().selectedModelNames.forEach((e=>t.addModel(e)))),500),f.o.subscribe((e=>T((e=>i(e)),e)),(e=>e.lyricChars)),f.o.subscribe((e=>(async(e,t)=>{await(0,d.mx)(t),T(e,void 0),T(e,f.o.getState().lyricChars)})((e=>i(e)),e)),(e=>e.fontName))}),[]),(0,s.BX)(s.HY,{children:[(0,s.tZ)(E,{id:"canvas-stage",ref:o,zIndex:e},void 0),(0,s.tZ)(a.Hf,Object.assign({ref:h,width:window.innerWidth,height:window.innerHeight,css:r.iv`
          display: block;
          z-index: ${e};
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          max-width: 100vw;
          height: 100vh;
          max-height: 100vh;
        `},{children:(0,s.tZ)(a.mh,{children:t},void 0)}),void 0)]},void 0)}}}]);
//# sourceMappingURL=123.chunk.js.map